---
title: "project3"
author: "Sibei Liu sl4660"
date: "2020/4/14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message=FALSE,warning=TRUE)
library(tidyverse)
library(ggplot2)
```

data cleaning
```{r}
df.raw = read.csv("covid19-1.csv")
df = df.raw %>% 
  janitor::clean_names() %>% 
  select(country_region, province_state, date, confirmed_cases) %>% 
  filter(confirmed_cases != 0)

region.index = levels(df$country_region)

df.region = function(df, region) {
  df.r = df %>% 
    filter(country_region == region) %>% 
    group_by(country_region, date) %>% 
    summarise(cases = sum(confirmed_cases)) %>% 
    mutate(formal_date = as.Date(date, '%m/%d/%Y')) %>% 
    mutate(time = as.numeric(formal_date-min(formal_date)))%>% 
    arrange(time) %>% 
    mutate(cul=cumsum(cases)) %>% 
    dplyr::select(region = country_region, date, time, cases, cul)
  df.r
}

df.afghanistan = df.region(df, region.index[1])
```

```{r}
## calculate y
f_log=function(betavec,t){
  y = betavec[1]/(1+exp(-betavec[2]*(t-betavec[3])))
  return(y)
}

## calculate mse
target <- function(dat,beta) {
  x = dat$time
  y = dat$cul
  y_hat = f_log(beta,x)
  mse <- sum((y_hat-y)^2)
  return(mse)
}

## fix b and c, calculate a
fun_a = function(dat,beta){
  x = dat$time
  y = dat$cul
  a = beta[1]
  b = beta[2]
  c = beta[3]
  e = 1+exp(-b*x+b*c)
  a = sum(y/e)/sum(1/e^2)
}

## calculate b and c
fun_bc = function(dat,a){
  x = dat$time
  y = dat$cul
  y_trans = log(a/y-1)
  lm1 = lm(y_trans~x)
  b =  b = -as.numeric(lm1$coefficients[2])
  c =  as.numeric(lm1$coefficients[1])/b
  betavec = c(a,b,c)
  return(betavec)
}

## coordinatewise
coordinate <- function(dat, start, tol=1e-10, maxiter = 200) {
  i <- 0
  betavec <- start
  target <- target(dat,betavec)
  res <- c(0, target, betavec)
  prevtarget <- -Inf 
  while(i < maxiter && abs(target - prevtarget) > tol) {
    i <- i + 1 
    prevtarget <- target
    prev <- betavec
    a = fun_a(dat,prev)
    betavec = fun_bc(dat,a)
    target = target(dat,betavec)
    res <- rbind(res, c(i, target, betavec))}  
  return(res)
}

ggplot(aes(x = time, y = cul),data = df.afghanistan) +
  geom_point()

corres <- coordinate(df.afghanistan, start = c(10000,1,40))
```
