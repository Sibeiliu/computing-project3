---
title: "project3"
author: "Sibei Liu sl4660"
date: "2020/4/14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message=FALSE,warning=TRUE)
library(tidyverse)
```

data cleaning
```{r}
data_all=read_csv("covid19-1.csv") 
names(data_all)=c("id","province","region","lat","long","date","confirm","fatality") 
# incorporate privince data
clean_data=data_all %>% filter(confirm>0) %>% select(-lat,-long) %>% group_by(region,date) %>%summarise(case=sum(confirm)) 
g=split(clean_data,clean_data$region)
i=1
for(i  in 1:length(g)){
  h=NULL
  d=1
for(d in 1:nrow(g[[i]]))
{h[d]=as.numeric(as.Date(strptime( "1/1/20", "%m/%d/%y"))-as.Date(strptime(g[[i]][d,2], "%m/%d/%y")))
d=d+1}
  initial=(g[[i]][which(h==max(h)),2])
g[[i]]=g[[i]]%>% mutate(
  t_diff=as.numeric(as.Date(strptime(date, "%m/%d/%y"))-as.Date(strptime(initial, "%m/%d/%y")))) %>% 
  mutate(cul=cumsum(case))
i=i+1
}
update=NULL
for( c in 1:length(g))
update=rbind(update,g[[c]])
trial_data=update %>% filter(region=="China")
afghanistan = update %>% filter(region == "Afghanistan")
```

```{r}
## calculate y
f_log=function(betavec,t){
  y = betavec[1]/(1+exp(-betavec[2]*(t-betavec[3])))
  return(y)
}

## calculate mse
target <- function(dat,beta) {
  x = dat$t_diff
  y = dat$cul
  y_hat = f_log(beta,x)
  mse <- sum((y_hat-y)^2)
  return(mse)
}

## fix b and c, calculate a
fun_a = function(dat,beta){
  x = dat$t_diff
  y = dat$cul
  a = beta[1]
  b = beta[2]
  c = beta[3]
  e = 1+exp(-b*x+b*c)
  a = sum(y/e)/sum(1/e^2)
}

## calculate b and c
fun_bc = function(dat,a){
  x = dat$t_diff
  y = dat$cul
  y_trans = log(a/y-1)
  lm1 = lm(y_trans~x)
  b =  b = -as.numeric(lm1$coefficients[2])
  c =  as.numeric(lm1$coefficients[1])/b
  betavec = c(a,b,c)
  return(betavec)
}

## coordinatewise
coordinate <- function(dat, start, tol=1e-10, maxiter = 200) {
  i <- 0
  betavec <- start
  target <- target(dat,betavec)
  res <- c(0, target, betavec)
  prevtarget <- -Inf 
  while(i < maxiter && abs(target - prevtarget) > tol) {
    i <- i + 1 
    prevtarget <- target
    prev <- betavec
    a = fun_a(dat,prev)
    betavec = fun_bc(dat,a)
    target = target(dat,betavec)
    res <- rbind(res, c(i, target, betavec))}  
  return(res)
}

corres <- coordinate(afghanistan, start = c(10000,1,30))
```